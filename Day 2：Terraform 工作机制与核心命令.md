Day 2ï¼šTerraform å·¥ä½œæœºåˆ¶ä¸æ ¸å¿ƒå‘½ä»¤

ä»Šå¤©æˆ‘ä»¬æ­£å¼ä¸Šæ‰‹ Terraform çš„æ‰§è¡Œæµç¨‹ï¼Œ
é€šè¿‡å®è·µç†è§£ Terraform å¦‚ä½•ä»ä»£ç ç”ŸæˆçœŸå®çš„ Azure èµ„æºã€‚

ğŸ¯ å­¦ä¹ ç›®æ ‡

ç†è§£ Terraform çš„å·¥ä½œç›®å½•ç»“æ„ä¸æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ

æŒæ¡å››ä¸ªæ ¸å¿ƒå‘½ä»¤ï¼šinitã€planã€applyã€destroy

äº†è§£æ‰§è¡Œè®¡åˆ’ï¼ˆPlanï¼‰ä¸çŠ¶æ€æ–‡ä»¶ï¼ˆStateï¼‰çš„å…³ç³»

äº²æ‰‹éƒ¨ç½²å¹¶åˆ é™¤ç¬¬ä¸€ä¸ª Azure èµ„æº

ğŸ“˜ ä¸€ã€Terraform å·¥ä½œæœºåˆ¶

Terraform æ˜¯ä¸€ä¸ªå£°æ˜å¼çš„ IaC å·¥å…·ï¼Œä½ å‘Šè¯‰å®ƒâ€œä½ æƒ³è¦çš„æœ€ç»ˆçŠ¶æ€â€ï¼Œ
Terraform ä¼šè‡ªåŠ¨è®¡ç®—â€œå½“å‰çŠ¶æ€ â†’ ç›®æ ‡çŠ¶æ€â€çš„å·®å¼‚ï¼Œç„¶åæ‰§è¡Œå˜æ›´ã€‚

Terraform å·¥ä½œåŸç†æµç¨‹å¦‚ä¸‹ï¼š

1ï¸âƒ£ ç¼–å†™é…ç½®æ–‡ä»¶ï¼ˆ.tfï¼‰
    â†“
2ï¸âƒ£ terraform init
    åˆå§‹åŒ–é¡¹ç›®å¹¶ä¸‹è½½ provider æ’ä»¶
    â†“
3ï¸âƒ£ terraform plan
    è§£æ .tf æ–‡ä»¶ï¼Œç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼ˆPreviewï¼‰
    â†“
4ï¸âƒ£ terraform apply
    åº”ç”¨è®¡åˆ’ï¼Œå®é™…åœ¨ Azure åˆ›å»ºèµ„æº
    â†“
5ï¸âƒ£ terraform destroy
    é”€æ¯åœ¨ state ä¸­è®°å½•çš„æ‰€æœ‰èµ„æº

ğŸ“— äºŒã€å‡†å¤‡é¡¹ç›®ç›®å½•

åœ¨æ˜¨å¤©çš„ç›®å½•ä¸‹ç»§ç»­æ“ä½œï¼š

cd ~/terraform-azure-lab


åˆ›å»ºæ–‡ä»¶ç»“æ„ï¼š

terraform-azure-lab/
â”œâ”€â”€ provider.tf
â””â”€â”€ main.tf

ğŸ“™ ä¸‰ã€å®šä¹‰ç¬¬ä¸€ä¸ªèµ„æº

åœ¨ main.tf ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

# main.tf
resource "azurerm_resource_group" "rg" {
  name     = "tf-day2-rg"
  location = "East US"
}


è§£é‡Šï¼š

resourceï¼šå®šä¹‰ä¸€ä¸ªèµ„æºå—ã€‚

"azurerm_resource_group"ï¼šèµ„æºç±»å‹ï¼ˆAzure Resource Groupï¼‰ã€‚

"rg"ï¼šèµ„æºé€»è¾‘åç§°ï¼ˆåœ¨ state ä¸­çš„å¼•ç”¨åï¼‰ã€‚

name / locationï¼šAzure RG çš„å±æ€§ã€‚

âš™ï¸ å››ã€æ ¸å¿ƒå‘½ä»¤è¯¦è§£ä¸å®æ“
1ï¸âƒ£ åˆå§‹åŒ–é¡¹ç›®
terraform init


ä½œç”¨ï¼š

åˆå§‹åŒ–å·¥ä½œç›®å½•ï¼›

ä¸‹è½½ provider æ’ä»¶ï¼›

ç”Ÿæˆ .terraform ç›®å½•ï¼›

åˆ›å»ºåˆå§‹ terraform.lock.hclï¼ˆä¾èµ–ç‰ˆæœ¬é”å®šæ–‡ä»¶ï¼‰ã€‚

ğŸ’¡ å¦‚æœä½ ä¿®æ”¹äº† provider ç‰ˆæœ¬ï¼Œéœ€è¦é‡æ–°è¿è¡Œ terraform init -upgradeã€‚

2ï¸âƒ£ é¢„è§ˆæ‰§è¡Œè®¡åˆ’
terraform plan


ä½œç”¨ï¼š

Terraform ä¼šè§£æ .tf æ–‡ä»¶ï¼›

æ¯”è¾ƒå½“å‰çŠ¶æ€ï¼ˆtfstateï¼‰ä¸é…ç½®æ–‡ä»¶å®šä¹‰ï¼›

ç”Ÿæˆä¸€ä¸ªæ‰§è¡Œè®¡åˆ’ï¼ˆä¸å®é™…æ‰§è¡Œï¼‰ã€‚

ç¤ºä¾‹è¾“å‡ºï¼š

Plan: 1 to add, 0 to change, 0 to destroy.


è§£é‡Šï¼š

addï¼šè¦æ–°å»ºçš„èµ„æºæ•°é‡ï¼›

changeï¼šè¦æ›´æ–°çš„èµ„æºæ•°é‡ï¼›

destroyï¼šè¦åˆ é™¤çš„èµ„æºæ•°é‡ã€‚

3ï¸âƒ£ æ‰§è¡Œè®¡åˆ’ï¼ˆçœŸæ­£éƒ¨ç½²ï¼‰
terraform apply


æ‰§è¡Œæ—¶ Terraform ä¼šå†æ¬¡ç”Ÿæˆ plan å¹¶è¦æ±‚ç¡®è®¤ï¼š

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.


è¾“å…¥ï¼š

yes


å‡ åˆ†é’Ÿåï¼Œä½ å°†åœ¨ Azure Portal ä¸­çœ‹åˆ°åä¸º tf-day2-rg çš„èµ„æºç»„ã€‚

4ï¸âƒ£ æ£€æŸ¥çŠ¶æ€æ–‡ä»¶

Terraform ä¼šè‡ªåŠ¨ç”Ÿæˆï¼š

terraform.tfstate


æŸ¥çœ‹ï¼š

terraform show


æˆ–è€…æŸ¥çœ‹èµ„æºåˆ—è¡¨ï¼š

terraform state list


è¾“å‡ºç¤ºä¾‹ï¼š

azurerm_resource_group.rg


ğŸ§  State æ–‡ä»¶æ˜¯ Terraform çš„â€œè®°å¿†â€ï¼Œå®ƒè®°å½•äº†ï¼š

å“ªäº›èµ„æºå·²åˆ›å»ºï¼›

å®ƒä»¬çš„å±æ€§å€¼ï¼›

Terraform ä¸äº‘ç¯å¢ƒçš„æ˜ å°„å…³ç³»ã€‚

5ï¸âƒ£ é”€æ¯èµ„æº
terraform destroy


Terraform ä¼šè¯»å– state æ–‡ä»¶ï¼Œåˆ é™¤æ‰€æœ‰è®°å½•çš„èµ„æºã€‚
è¾“å…¥ yes ç¡®è®¤åï¼ŒAzure Portal ä¸­çš„èµ„æºç»„å°†è¢«åˆ é™¤ã€‚

ğŸ’¡ destroy åªåˆ é™¤ Terraform ç®¡ç†çš„èµ„æºï¼ŒPortal æ‰‹åŠ¨åˆ›å»ºçš„ä¸å—å½±å“ã€‚

ğŸ“ˆ äº”ã€æ‰§è¡Œå‘½ä»¤æ€»ç»“è¡¨
å‘½ä»¤	ä½œç”¨	æ˜¯å¦ä¿®æ”¹èµ„æº	å¤‡æ³¨
terraform init	åˆå§‹åŒ–ç›®å½•ã€ä¸‹è½½ provider	âŒ å¦	é¦–æ¬¡è¿è¡Œå¿…é¡»æ‰§è¡Œ
terraform plan	é¢„è§ˆå°†è¦æ‰§è¡Œçš„æ“ä½œ	âŒ å¦	å¯åå¤æ‰§è¡Œ
terraform apply	å®é™…åˆ›å»ºæˆ–ä¿®æ”¹èµ„æº	âœ… æ˜¯	è‡ªåŠ¨æ›´æ–° state
terraform destroy	åˆ é™¤æ‰€æœ‰ Terraform ç®¡ç†çš„èµ„æº	âœ… æ˜¯	æ…ç”¨ï¼Œéœ€ç¡®è®¤
terraform show	æŸ¥çœ‹ state æ–‡ä»¶å†…å®¹	âŒ å¦	ä¾¿äºè°ƒè¯•
ğŸ§© å…­ã€Day 2 å®è·µä»»åŠ¡

1ï¸âƒ£ åœ¨æœ¬åœ°æ‰§è¡Œï¼š

terraform init
terraform plan
terraform apply


2ï¸âƒ£ æ‰“å¼€ Azure Portalï¼ŒéªŒè¯èµ„æºç»„æ˜¯å¦åˆ›å»ºã€‚
3ï¸âƒ£ æ‰§è¡Œï¼š

terraform state list


æŸ¥çœ‹ Terraform ç®¡ç†çš„èµ„æºã€‚
4ï¸âƒ£ æœ€åæ‰§è¡Œï¼š

terraform destroy


åˆ é™¤èµ„æºã€‚

ğŸ§  ä¸ƒã€Day 2 æ€è€ƒé¢˜ï¼ˆæŒæ¡å…³é”®ç†è§£ï¼‰

Terraform å¦‚ä½•åˆ¤æ–­è¦åˆ›å»ºã€ä¿®æ”¹æˆ–åˆ é™¤èµ„æºï¼Ÿ

å¦‚æœæˆ‘æ‰‹åŠ¨åœ¨ Portal ä¸­ä¿®æ”¹äº†èµ„æºï¼ŒTerraform çš„ plan ä¼šæ˜¾ç¤ºä»€ä¹ˆï¼Ÿ

ä¸ºä»€ä¹ˆ Terraform éœ€è¦ state æ–‡ä»¶ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½ç›´æ¥æ‰«æ Azureï¼Ÿ

ç­”æ¡ˆï¼ˆç®€ç•¥ï¼‰ï¼š

Terraform é€šè¿‡å¯¹æ¯” state æ–‡ä»¶ä¸å½“å‰é…ç½®æ–‡ä»¶ï¼›

å¦‚æœ Portal æ”¹åŠ¨ï¼Œplan ä¼šæ£€æµ‹å‡º driftï¼ˆåç§»ï¼‰ï¼›

å› ä¸ºæ‰«æäº‘èµ„æºè€—æ—¶å¤§ã€æƒé™å¤æ‚ã€æ€§èƒ½ä½ã€‚

âœ… Day 2 æˆæœéªŒè¯
æ£€æŸ¥é¡¹	æ˜¯å¦å®Œæˆ
Terraform init æˆåŠŸæ‰§è¡Œ	âœ…
Terraform plan è¾“å‡º â€œ1 to addâ€	âœ…
Terraform apply æˆåŠŸåˆ›å»ºèµ„æºç»„	âœ…
Terraform destroy æˆåŠŸåˆ é™¤èµ„æº	âœ…
ç†è§£ state æ–‡ä»¶ä¸ plan çš„å…³ç³»	âœ…