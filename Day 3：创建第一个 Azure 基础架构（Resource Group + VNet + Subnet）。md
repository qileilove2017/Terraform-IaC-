Day 3ï¼šåˆ›å»ºç¬¬ä¸€ä¸ª Azure åŸºç¡€æ¶æ„ï¼ˆResource Group + VNet + Subnetï¼‰

ä»Šå¤©å¼€å§‹ï¼Œæˆ‘ä»¬ä»â€œå•èµ„æºâ€è¿ˆå‘â€œå¤šèµ„æºâ€çš„ Terraform é…ç½®ï¼Œ
ç†è§£èµ„æºé—´çš„ä¾èµ–å…³ç³»ï¼Œå¹¶æ„å»ºä¸€ä¸ªå®Œæ•´çš„è™šæ‹Ÿç½‘ç»œç¯å¢ƒã€‚

ğŸ¯ å­¦ä¹ ç›®æ ‡

å­¦ä¼šå®šä¹‰å¤šä¸ª Azure èµ„æºï¼ˆèµ„æºç»„ã€è™šæ‹Ÿç½‘ç»œã€å­ç½‘ï¼‰ã€‚

ç†è§£èµ„æºä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼ˆéšå¼ä¾èµ–ä¸æ˜¾å¼ä¾èµ–ï¼‰ã€‚

è®¤è¯† HCLï¼ˆHashiCorp Configuration Languageï¼‰çš„å¯è¯»æ€§ä¸ç»“æ„åŒ–è¡¨è¾¾æ–¹å¼ã€‚

æŒæ¡ Terraform åœ¨å¤šèµ„æºä¸‹çš„æ‰§è¡Œé€»è¾‘ã€‚

ğŸ“˜ ä¸€ã€æ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼šèµ„æºä¾èµ–ä¸ HCL è¯­æ³•
ğŸ”¹ Terraform èµ„æºä¾èµ–æœºåˆ¶

Terraform èƒ½è‡ªåŠ¨æ¨æ–­èµ„æºä¹‹é—´çš„å…³ç³»ï¼Œä¾‹å¦‚ï¼š

ä¸€ä¸ª azurerm_virtual_network ä¾èµ–äº azurerm_resource_groupï¼›

ä¸€ä¸ª azurerm_subnet ä¾èµ–äº azurerm_virtual_networkã€‚

è¿™ç§°ä¸º éšå¼ä¾èµ–ï¼ˆimplicit dependencyï¼‰ï¼Œ
å› ä¸º Terraform ä¼šè‡ªåŠ¨é€šè¿‡å¼•ç”¨å±æ€§ (resource_group_name = azurerm_resource_group.rg.name) è¯†åˆ«ã€‚

å½“å¼•ç”¨å…³ç³»ä¸æ˜æ˜¾æ—¶ï¼Œå¯ä»¥ç”¨ depends_on æ˜¾å¼å£°æ˜ã€‚

ğŸ“— äºŒã€åˆ›å»ºé¡¹ç›®æ–‡ä»¶ç»“æ„

ç»§ç»­åœ¨ä½ çš„é¡¹ç›®ç›®å½•ä¸­ï¼š

terraform-azure-lab/
â”œâ”€â”€ provider.tf
â”œâ”€â”€ main.tf
â””â”€â”€ variables.tf

ğŸ“™ ä¸‰ã€å®šä¹‰ Azure èµ„æºç»„ï¼ˆResource Groupï¼‰
# main.tf
resource "azurerm_resource_group" "rg" {
  name     = "tf-day3-rg"
  location = "East US"
}


ğŸ’¡ èµ„æºç»„æ˜¯æ‰€æœ‰ Azure èµ„æºçš„å®¹å™¨ï¼Œå¿…é¡»å…ˆåˆ›å»ºã€‚

ğŸ“— å››ã€åˆ›å»ºè™šæ‹Ÿç½‘ç»œï¼ˆVirtual Networkï¼‰
resource "azurerm_virtual_network" "vnet" {
  name                = "tf-day3-vnet"
  location            = azurerm_resource_group.rg.location
  resource_group_name = azurerm_resource_group.rg.name
  address_space       = ["10.20.0.0/16"]

  tags = {
    environment = "dev"
    owner       = "zhen.liang"
  }
}


è§£é‡Šï¼š

address_spaceï¼šå®šä¹‰è™šæ‹Ÿç½‘ç»œç½‘æ®µã€‚

resource_group_nameï¼šå¼•ç”¨èµ„æºç»„ â†’ éšå¼ä¾èµ–ã€‚

Terraform ä¼šè‡ªåŠ¨å…ˆåˆ›å»º RGï¼Œå†åˆ›å»º VNetã€‚

ğŸ“˜ äº”ã€åˆ›å»ºå­ç½‘ï¼ˆSubnetï¼‰
resource "azurerm_subnet" "subnet" {
  name                 = "tf-day3-subnet"
  resource_group_name  = azurerm_resource_group.rg.name
  virtual_network_name = azurerm_virtual_network.vnet.name
  address_prefixes     = ["10.20.1.0/24"]
}


è§£é‡Šï¼š

å­ç½‘å¿…é¡»å±äºä¸€ä¸ªè™šæ‹Ÿç½‘ç»œï¼›

Terraform é€šè¿‡ virtual_network_name å¼•ç”¨è‡ªåŠ¨å»ºç«‹ä¾èµ–ã€‚

ğŸ“˜ å…­ã€å˜é‡åŒ–å‚æ•°ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

ä¸ºäº†æ–¹ä¾¿ç®¡ç†ï¼Œå®šä¹‰å˜é‡æ–‡ä»¶ variables.tfï¼š

variable "location" {
  type        = string
  default     = "East US"
  description = "Azure region"
}

variable "prefix" {
  type        = string
  default     = "tfday3"
  description = "å‘½åå‰ç¼€"
}


ä¿®æ”¹èµ„æºå‘½åä¸ºï¼š

resource "azurerm_resource_group" "rg" {
  name     = "${var.prefix}-rg"
  location = var.location
}
resource "azurerm_virtual_network" "vnet" {
  name                = "${var.prefix}-vnet"
  location            = var.location
  resource_group_name = azurerm_resource_group.rg.name
  address_space       = ["10.20.0.0/16"]
}
resource "azurerm_subnet" "subnet" {
  name                 = "${var.prefix}-subnet"
  resource_group_name  = azurerm_resource_group.rg.name
  virtual_network_name = azurerm_virtual_network.vnet.name
  address_prefixes     = ["10.20.1.0/24"]
}

âš™ï¸ ä¸ƒã€æ‰§è¡Œä¸éªŒè¯
åˆå§‹åŒ–é¡¹ç›®
terraform init

ç”Ÿæˆæ‰§è¡Œè®¡åˆ’
terraform plan


è¾“å‡ºï¼š

Plan: 3 to add, 0 to change, 0 to destroy.

æ‰§è¡Œéƒ¨ç½²
terraform apply


è¾“å…¥ yes å Terraform ä¼šä¾æ¬¡åˆ›å»ºï¼š
1ï¸âƒ£ Resource Group
2ï¸âƒ£ Virtual Network
3ï¸âƒ£ Subnet

ğŸ” å…«ã€æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
æŸ¥çœ‹å·²éƒ¨ç½²èµ„æº
terraform state list


è¾“å‡ºï¼š

azurerm_resource_group.rg
azurerm_virtual_network.vnet
azurerm_subnet.subnet

æŸ¥çœ‹å•ä¸ªèµ„æºè¯¦æƒ…
terraform state show azurerm_virtual_network.vnet

ğŸ§  ä¹ã€Terraform çš„ä¾èµ–åˆ†æé€»è¾‘ï¼ˆå¯è§†åŒ–ç†è§£ï¼‰

Terraform å†…éƒ¨ä¼šè‡ªåŠ¨æ„å»ºä¸€å¼ ä¾èµ–å›¾ï¼ˆDAGï¼šDirected Acyclic Graphï¼‰ï¼š

azurerm_resource_group.rg
    â””â”€â”€ azurerm_virtual_network.vnet
          â””â”€â”€ azurerm_subnet.subnet


ä½ å¯ä»¥ç”¨å‘½ä»¤ç”Ÿæˆä¾èµ–å›¾ï¼š

terraform graph | dot -Tpng > graph.png


ç„¶åæŸ¥çœ‹ graph.png å³å¯çœ‹åˆ°ä¾èµ–å…³ç³»ç»“æ„ã€‚

ğŸ§© åã€é”€æ¯èµ„æº

å½“ç»ƒä¹ å®Œæˆåå¯æ‰§è¡Œï¼š

terraform destroy


ç¡®è®¤åˆ é™¤ï¼š

Plan: 0 to add, 0 to change, 3 to destroy.

âœ… Day 3 æˆæœéªŒè¯æ¸…å•
éªŒè¯ç‚¹	æ˜¯å¦å®Œæˆ
æˆåŠŸè¿è¡Œ terraform init	âœ…
terraform plan è¾“å‡º â€œ3 to addâ€	âœ…
æˆåŠŸåˆ›å»ºèµ„æºç»„ã€è™šæ‹Ÿç½‘ç»œã€å­ç½‘	âœ…
èƒ½è§£é‡Šèµ„æºä¾èµ–ï¼ˆRGâ†’VNetâ†’Subnetï¼‰	âœ…
æˆåŠŸæ‰§è¡Œ terraform destroy æ¸…ç†èµ„æº	âœ…
ğŸ§  æ€è€ƒä¸æ‰©å±•ç»ƒä¹ 

å¦‚æœä½ åœ¨ Azure Portal æ‰‹åŠ¨åˆ é™¤å­ç½‘ï¼Œæ‰§è¡Œ terraform plan ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ
ğŸ‘‰ Terraform ä¼šæ£€æµ‹åˆ°èµ„æºç¼ºå¤±ï¼Œæç¤ºé‡æ–°åˆ›å»ºã€‚

å¦‚æœä¿®æ”¹ address_prefixesï¼ŒTerraform ä¼šæç¤ºæ›¿æ¢ï¼ˆforces replacementï¼‰ã€‚

å¯å°è¯•æ·»åŠ ç¬¬äºŒä¸ª Subnetï¼Œç»ƒä¹  for_each åŠ¨æ€åˆ›å»ºã€‚
